generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Employee {
  id String @id @default(cuid())

  firstName    String        @map("first_name")
  lastName     String?       @map("last_name")
  email        String        @unique
  phone        String
  dateOfBirth  DateTime?     @map("date_of_birth")
  hireDate     DateTime      @default(now()) @map("hire_date")
  salary       Decimal?
  address      String?
  password     String
  aadhaar      String?
  experience   Decimal?      @db.Decimal(5, 2)
  payrollItems PayrollItem[]

  // Relationships
  departmentId      String?                     @map("department_id")
  department        Department?                 @relation(fields: [departmentId], references: [id])
  salaryStructure   EmployeeSalaryStructure?
  roleId            String?                     @map("role_id")
  role              Role?                       @relation(fields: [roleId], references: [id])
  monthlyAttendance EmployeeMonthlyAttendance[]
  status            EmployeeStatus              @default(ACTIVE)
  projects          ProjectEmployee[]
  createdAt         DateTime                    @default(now()) @map("created_at")
  updatedAt         DateTime                    @updatedAt @map("updated_at")
  type              String                      @default("CONTRACT")
  paymentType       String                      @default("MONTHLY")

  @@index([departmentId])
  @@index([roleId])
  @@index([status])
  @@map("employees")
}

model Department {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  status      DepartmentStatus @default(ACTIVE)
  employees   Employee[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("departments")
}

model Role {
  id          String     @id @default(cuid())
  title       String     @unique
  description String?
  level       Int        @default(1) // Job level/grade
  status      RoleStatus @default(ACTIVE)
  employees   Employee[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum DepartmentStatus {
  ACTIVE
  INACTIVE
}

enum RoleStatus {
  ACTIVE
  INACTIVE
}

model SuperAdmin {
  id       String      @id @default(cuid())
  email    String      @unique
  password String
  status   AdminStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("super_admins")
}

enum AdminStatus {
  ACTIVE
  INACTIVE
}

model Project {
  id          String            @id @default(cuid())
  name        String            @unique
  description String?
  status      ProjectStatus     @default(ACTIVE)
  employees   ProjectEmployee[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  INACTIVE
}

// Add to the same schema.prisma file for extended functionality

model ProjectEmployee {
  id         String   @id @default(cuid())
  projectId  String   @map("project_id")
  employeeId String   @map("employee_id")
  project    Project  @relation(fields: [projectId], references: [id])
  employee   Employee @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("project_employees")
}

model EmployeeSalaryStructure {
  id String @id @default(cuid())

  employeeId String   @unique @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id])

  monthlySalary Decimal @map("monthly_salary") @db.Decimal(12, 2)
  basicPay      Decimal @map("basic_pay") @db.Decimal(12, 2)
  hra           Decimal @db.Decimal(12, 2)
  allowance     Decimal @db.Decimal(12, 2)

  otType        OtType   @default(FIXED) @map("ot_type")
  otRatePerHour Decimal? @map("ot_rate_per_hour") @db.Decimal(12, 2)
  otMultiplier  Decimal? @map("ot_multiplier") @db.Decimal(5, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([employeeId])
  @@map("employee_salary_structures")
}

enum OtType {
  FIXED
  MULTIPLIER
}

model AppSettings {
  id String @id @default(cuid())

  otType           OtType   @default(FIXED) @map("ot_type")
  fixedOtRate      Decimal? @map("fixed_ot_rate") @db.Decimal(12, 2)
  otMultiplier     Decimal? @map("ot_multiplier") @db.Decimal(5, 2)
  sundayMultiplier Decimal? @map("sunday_multiplier") @db.Decimal(5, 2)

  workingDays  Int @default(26) @map("working_days")
  workingHours Int @default(8) @map("working_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}

model EmployeeMonthlyAttendance {
  id String @id @default(cuid())

  employeeId String   @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id])

  month Int
  year  Int

  presentDays Decimal? @map("present_days") @db.Decimal(5, 2)
  otHours     Decimal? @map("ot_hours") @db.Decimal(7, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, month, year])
  @@index([month, year])
  @@index([employeeId])
  @@map("employee_monthly_attendance")
}

model PayrollRun {
  id        String        @id @default(cuid())
  month     Int
  year      Int
  status    PayrollStatus @default(DRAFT)
  items     PayrollItem[]
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@unique([month, year])
  @@index([month, year])
  @@map("payroll_runs")
}

model PayrollItem {
  id String @id @default(cuid())

  payrollRunId String     @map("payroll_run_id")
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id])

  employeeId String   @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id])

  // ✅ Snapshots from salary + attendance at the time payroll is generated
  monthlySalary Decimal @map("monthly_salary") @db.Decimal(12, 2)
  presentDays   Decimal @map("present_days") @db.Decimal(5, 2)
  otHours       Decimal @map("ot_hours") @db.Decimal(7, 2)

  // ✅ Salary breakup snapshot
  basicPay  Decimal @map("basic_pay") @db.Decimal(12, 2)
  hra       Decimal @db.Decimal(12, 2)
  allowance Decimal @db.Decimal(12, 2)

  // ✅ Calculated amounts snapshot
  regularPay Decimal @map("regular_pay") @db.Decimal(12, 2)
  otPay      Decimal @map("ot_pay") @db.Decimal(12, 2)
  grossPay   Decimal @map("gross_pay") @db.Decimal(12, 2)

  // ✅ Adjustments total snapshot (optional but very useful)
  adjustmentTotal Decimal @map("adjustment_total") @db.Decimal(12, 2)

  netPay Decimal @map("net_pay") @db.Decimal(12, 2)

  adjustments PayrollAdjustment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([payrollRunId, employeeId])
  @@index([employeeId])
  @@index([payrollRunId])
  @@map("payroll_items")
}

model PayrollAdjustment {
  id String @id @default(cuid())

  payrollItemId String      @map("payroll_item_id")
  payrollItem   PayrollItem @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)

  date   DateTime
  type   PayrollAdjustmentType
  amount Decimal               @db.Decimal(12, 2)
  reason String
  notes  String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([payrollItemId])
  @@index([date])
  @@map("payroll_adjustments")
}

enum PayrollStatus {
  DRAFT
  GENERATED
  PAID
}

enum PayrollAdjustmentType {
  ADDITION
  DEDUCTION
}
